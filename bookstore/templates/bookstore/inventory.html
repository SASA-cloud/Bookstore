{% extends "bookstore/base.html" %}


{#管理应用导航条#}
          {% block manageNav %}
        <li><a href="{% url 'index' %}">图书信息页面</a></li>
        <li  class="active"><a href="{% url 'inventory' %}">库存管理页面</a></li>
        <li><a href="{% url 'subscribe' %}">采编管理页面</a></li>
        <li><a href="{% url 'purchase' %}">进货管理页面</a></li>
        <li><a href="{% url 'finance' %}">财务管理页面</a></li>
        <li  ><a href="{% url 'user' %}">用户管理页面</a></li>
          {% endblock %}




{###########################查询##############################}
{% block searchInput %}
<form id="searchBookForm" class="form-inline" method = "POST"  action="{% url 'searchInventory' %}">
{% csrf_token %}
  <div class="form-group">
    <label for="exampleInputEmail2">书名</label>
    <input name="book_name" type="text"  class="form-control" id="exampleInputEmail2" placeholder="输入书名...">
  </div>

  <div class="form-group">
    <label for="exampleInputName2">作者</label>
    <input name = "author" type="text" class="form-control" id="exampleInputName2" placeholder="输入作者...">
  </div>

  <select name = "lib_list" id="lib_list" class="form-control">
  <option value="所有馆藏" >所有馆藏</option>
  <option value="文科馆" >文科馆</option>
  <option value="理科馆">理科馆</option>
  <option value="医科馆">医科馆</option>
  </select>

  <button type="submit" class="btn btn-default" >查询</button>
</form>
{% endblock %}
{###########################查询##############################}

{###########################列表##############################}
{% block tableInfo %}
<div class="table-responsive">
    <table class="table table-bordered table-striped table-hover">
    <thead>
    <th></th>
    {% for name in inventoryDisplayList %}
    <th>{{ name }}</th>
    {% endfor %}
    <th>操作</th>
    </thead>
    <tbody>
    {% if queryList %}
        {% for row in queryList %}
            <tr>
                <td> </td>
                <td class="book_id">{{ row.book_id }}</td>
                <td class="book_name">{{ row.book_name }}</td>
                <td class="author">{{ row.author }}</td>
                <td class="ISBN">{{ row.ISBN }}</td>
                <td class="publisher">{{ row.publisher }}</td>
                <td class="publish_date">{{ row.publish_date }}</td>
                <td class="location">{{ row.location }}</td>
                <td class="book_amount">{{ row.book_amount }}</td>
                <td class="operate">
                    <a href="#"  data-toggle="modal" data-target="#modifyInventoryModal" onclick="modify_inventory(this)">修改</a>
                    <a href="#" onclick="delete_inventory(this)">删除</a>
                </td>
            </tr>

        {% endfor %}
    {% endif %}
    </tbody>
    </table>
</div>

{% endblock %}
{###########################列表##############################}

{############################控制操作#########################}
{% block controlBtn %}
<!-- Button trigger modal -->
<button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#insertInventoryModal">
  添加库存
</button>
{% endblock %}
{############################控制操作#########################}


{########################添加库存模态框########################}
{% block modal %}
<div class="modal fade" id="insertInventoryModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">添加库存</h4>
      </div>
      <div class="modal-body">
{#          输入组框#}
    <form id="inputbookForm">
    {% csrf_token %}
          {% if inventoryTableList %}
      {% for nm in inventoryTableList %}
          <div class="input-group">
          <span class="input-group-addon" id="basic-addon1">{{ nm }}</span>
          <input type="text" class="form-control" name="{{ nm }}" placeholder="..." aria-describedby="basic-addon1">
          </div>
      {% endfor %}
  {% endif %}
    </form>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="insert_inventory()">Save changes</button>
      </div>
    </div>
  </div>
</div>


{##########修改库存信息模态框########################}
<div class="modal fade" id="modifyInventoryModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">修改图书信息</h4>
      </div>
      <div class="modal-body">
{#          输入组框#}
    <form id="modifybookForm">
    {% csrf_token %}
          {% if inventoryTableList %}
      {% for nm in inventoryTableList %}
          <div class="input-group">
          <span class="input-group-addon" id="basic-addon1">{{ nm }}</span>
          <input type="text" class="form-control" name="{{ nm }}" placeholder="..." aria-describedby="basic-addon1">
          </div>
      {% endfor %}
  {% endif %}
    </form>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="submit_modify_book()" >Save changes</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
    <script>
    //添加库存
    function insert_inventory(){
        inputbookForm = document.getElementById("inputbookForm");
        var formData = new FormData(inputbookForm);
         $.ajax({
             url: "{% url 'insertInventory' %}",
             type: "POST",
             data: formData,
             processData: false,
             contentType: false,
             success: function (backData) {
                 if(backData.status==="0")//插入成功
                 alert("添加成功!");
                 else if(backData.status==="1")// 插入失败
                 alert("添加失败!");
             }
         })
    }

    //修改库存信息
    function modify_inventory(obj){
        row = $(obj).parent().parent(); // 操作的行
        let modifybookForm = document.getElementById("modifybookForm");  // 图书信息的输入框
        cols = $(row).children(); // 一行的各列
        modify_box_list = $(modifybookForm).children();// 图书信息输入框列表
        $(modify_box_list[1]).children("input").val($(row).children('.book_id').text()); // 把该行的信息展示在输入框里
        $(modify_box_list[2]).children("input").val($(row).children('.location').text()); // 把该行的信息展示在输入框里
        $(modify_box_list[3]).children("input").val($(row).children('.book_amount').text()); // 把该行的信息展示在输入框里
    }

    //提交保存修改信息：
    function submit_modify_book(){
        modifybookForm = document.getElementById("modifybookForm");  // 图书信息的输入框
        var formData = new FormData(modifybookForm);
         $.ajax({
             url: "{% url 'modifyInventory' %}",
             type: "POST",
             data: formData,
             processData: false,
             contentType: false,
             success: function (backData) {
                 if(backData.status==="0")//插入成功
                 alert("添加成功!");
                 else if(backData.status==="1")// 插入失败
                 alert("添加失败!");
             }
         })
    }


    //删除库存信息
    function delete_inventory(obj){
        ret = confirm("确定删除库存吗？");
        if(ret){  //确定
            row = $(obj).parent().parent(); // 操作的行
            $.ajax({
             url: "{% url 'deleteInventory' %}",
             type: "POST",
             data: {
                 "book_id":$(row).children('.book_id').text(),
                 "location":$(row).children('.location').text(),
             },
             success: function (backData) {
                 if(backData.status==="0")//减少成功
                 alert("删除成功!");
                 else if(backData.status==="1")// 减少失败
                 alert("删除失败!");
             }
         })
        }
    }

</script>
{% endblock %}

