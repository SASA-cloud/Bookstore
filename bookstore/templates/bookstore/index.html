{% extends "bookstore/base.html" %}


{#管理应用导航条#}
          {% block manageNav %}
        <li class="active"><a href="{% url 'index' %}">图书信息页面</a></li>
        <li><a href="{% url 'inventory' %}">库存管理页面</a></li>
        <li><a href="{% url 'subscribe' %}">采编管理页面</a></li>
        <li><a href="{% url 'purchase' %}">进货管理页面</a></li>
        <li><a href="{% url 'finance' %}">财务管理页面</a></li>
        <li  ><a href="{% url 'user' %}">用户管理页面</a></li>
          {% endblock %}




{###########################查询图书##############################}
{% block searchInput %}
<form id="searchBookForm" class="form-inline" method = "POST"  action="{% url 'searchBook' %}">
{% csrf_token %}
  <div class="form-group">
    <label for="exampleInputEmail2">书名</label>
    <input name="book_name" type="text"  class="form-control" id="exampleInputEmail2" placeholder="输入书名...">
  </div>

  <div class="form-group">
    <label for="exampleInputName2">作者</label>
    <input name = "author" type="text" class="form-control" id="exampleInputName2" placeholder="输入作者...">
  </div>

  <div class="form-group">
    <label for="exampleInputEmail2">ISBN</label>
    <input name="ISBN" type="text" class="form-control" id="exampleInputEmail2" placeholder="输入ISBN...">
  </div>
  <button type="submit" class="btn btn-default" >Send invitation</button>
</form>
{% endblock %}

{###########################查询图书##############################}

{###########################图书列表##############################}

{% block tableInfo %}
    <div id = "tbl" class="table-responsive" >
    <table class="table table-bordered table-striped table-hover">
    <thead>
    <th></th>
    {% for name in bookTableList %}
        <th>{{ name }}</th>
    {% endfor %}
        <th>操作</th>
    </thead>
    <tbody>
    {% if queryBookList %}
        {% for row in queryBookList %}
            <tr>
                <td> </td>
                <td>{{ row.book_id }}</td>
                <td>{{ row.ISBN }}</td>
                <td>{{ row.book_name }}</td>
                <td>{{ row.publisher }}</td>
                <td>{{ row.author }}</td>
                <td>{{ row.publish_date }}</td>
                <td>{{ row.unit_price }}</td>
                <td>{{ row.link }}</td>
                <td>{{ row.book_rank }}</td>
                <td>{{ row.book_class }}</td>
                <td>
                    <a href="#"  data-toggle="modal" data-target="#modifyBookModal" onclick="modify_inventory(this)">修改</a>
                    <a href="#" onclick="delete_book(this)">删除</a>
                </td>
            </tr>

        {% empty %}
            <h3>暂无图书信息</h3>
        {% endfor %}
    {% endif %}
    </tbody>
    </table>
</div>
{% endblock %}



{############################控制操作#########################}

{% block controlBtn %}
    <!-- Button trigger modal -->
<button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#insertBookModal">
  添加图书
</button>
{% endblock %}




{########################添加图书模态框########################}
{% block modal %}

<div class="modal fade" id="insertBookModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">添加图书</h4>
      </div>
      <div class="modal-body">
{#          输入组框#}
    <form id="inputbookForm">
    {% csrf_token %}
          {% if bookTableList %}
      {% for nm in bookTableList %}
          {% if nm != 'book_id' %}
          <div class="input-group">
          <span class="input-group-addon" id="basic-addon1">{{ nm }}</span>
          <input type="text" class="form-control" name="{{ nm }}" placeholder="..." aria-describedby="basic-addon1">
          </div>
            {% endif %}
      {% endfor %}
  {% endif %}
    </form>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="insert_book()">Save changes</button>
      </div>
    </div>
  </div>
</div>


{##########修改图书信息模态框########################}
<div class="modal fade" id="modifyBookModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">修改图书信息</h4>
      </div>
      <div class="modal-body">
{#          输入组框#}
    <form id="modifybookForm">
    {% csrf_token %}
          {% if bookTableList %}
      {% for nm in bookTableList %}
          {% if nm != 'book_id' %}
          <div class="input-group">
          <span class="input-group-addon" id="basic-addon1">{{ nm }}</span>
          <input type="text" class="form-control" name="{{ nm }}" placeholder="..." aria-describedby="basic-addon1">
          </div>
          {% endif %}
      {% endfor %}
  {% endif %}
    </form>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="submit_modify_book()" >Save changes</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block js %}
<script>
    //添加图书
    function insert_book(){
        inputbookForm = document.getElementById("inputbookForm");
        var formData = new FormData(inputbookForm);
         $.ajax({
             url: "{% url 'insertBook' %}",
             type: "POST",
             data: formData,
             processData: false,
             contentType: false,
             success: function (backData) {
                 if(backData.status==="0")//插入成功
                 alert("添加成功!");
                 else if(backData.status==="1")// 插入失败
                 alert("添加失败!");
             }
         })
    }

    //修改图书信息
    function modify_inventory(obj){
        row = $(obj).parent().parent(); // 操作的行
        let modifybookForm = document.getElementById("modifybookForm");  // 图书信息的输入框
        cols = $(row).children(); // 一行的各列
        {#console.log($(cols[1]).text());#}
        modify_box_list = $(modifybookForm).children();// 图书信息输入框列表
        for (let i = 1;i<=10;i++){
            $(modify_box_list[i]).children("input").val($(cols[i]).text()); // 把该行的信息展示在输入框里
        }
    }

    //提交保存修改信息：
    function submit_modify_book(){
        modifybookForm = document.getElementById("modifybookForm");  // 图书信息的输入框
        var formData = new FormData(modifybookForm);
         $.ajax({
             url: "{% url 'modifyBook' %}",
             type: "POST",
             data: formData,
             processData: false,
             contentType: false,
             success: function (backData) {
                 if(backData.status==="0")//插入成功
                 alert("添加成功!");
                 else if(backData.status==="1")// 插入失败
                 alert("添加失败!");
             }
         })
    }
    //删除图书信息
    function delete_book(obj){
        ret = confirm("确定删除吗？");
        if(ret){  //确定删除
            row = $(obj).parent().parent(); // 操作的行
            cols = $(row).children(); // 一行的各列
            $.ajax({
             url: "{% url 'deleteBook' %}",
             type: "POST",
             data: {
                 "book_id":$(cols[1]).text(),
             },
             success: function (backData) {
                 if(backData.status==="0")//插入成功
                 alert("删除成功!");
                 else if(backData.status==="1")// 插入失败
                 alert("删除失败!");
             }
         })
        }
    }

    function search_book(){
        searchBookForm = document.getElementById("searchBookForm");
        var formData = new FormData(searchBookForm);
         $.ajax({
             url: "{% url 'searchBook' %}",
             type: "POST",
             data: formData,
             processData: false,
             contentType: false
         })
    }

</script>
{% endblock %}


